$OpenBSD: patch-src_tcpconns_c,v 1.5 2015/05/03 10:41:35 landry Exp $
https://github.com/collectd/collectd/pull/779
https://github.com/collectd/collectd/pull/808
--- src/tcpconns.c.orig	Thu Feb 26 11:43:48 2015
+++ src/tcpconns.c	Sat May  2 20:11:03 2015
@@ -909,7 +909,6 @@ static int conn_init (void)
 static int conn_read (void)
 {
   struct inpcbtable table;
-  struct inpcb *head;
   struct inpcb *next;
   struct inpcb inpcb;
   struct tcpcb tcpcb;
@@ -922,18 +921,16 @@ static int conn_read (void)
   if (status != 0)
     return (-1);
 
-  /* Get the `head' pcb */
-  head = (struct inpcb *) &(inpcbtable_ptr->inpt_queue);
   /* Get the first pcb */
-  next = (struct inpcb *)CIRCLEQ_FIRST (&table.inpt_queue);
+  next = (struct inpcb *)TAILQ_FIRST (&table.inpt_queue);
 
-  while (next != head)
+  while (next)
   {
     /* Read the pcb pointed to by `next' into `inpcb' */
     kread ((u_long) next, &inpcb, sizeof (inpcb));
 
     /* Advance `next' */
-    next = (struct inpcb *)CIRCLEQ_NEXT (&inpcb, inp_queue);
+    next = (struct inpcb *)TAILQ_NEXT (&inpcb, inp_queue);
 
     /* Ignore sockets, that are not connected. */
 #ifdef __NetBSD__
@@ -950,7 +947,7 @@ static int conn_read (void)
 
     kread ((u_long) inpcb.inp_ppcb, &tcpcb, sizeof (tcpcb));
     conn_handle_ports (ntohs(inpcb.inp_lport), ntohs(inpcb.inp_fport), tcpcb.t_state);
-  } /* while (next != head) */
+  } /* while (next) */
 
   conn_submit_all ();
 
