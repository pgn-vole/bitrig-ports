$OpenBSD: patch-modules_codec_avcodec_encoder_c,v 1.5 2015/04/30 06:32:21 ajacoutot Exp $

Deal with newer FFmpeg API.

--- modules/codec/avcodec/encoder.c.orig	Fri Feb 21 10:27:16 2014
+++ modules/codec/avcodec/encoder.c	Wed Apr 29 00:41:48 2015
@@ -257,6 +257,12 @@ int OpenEncoder( vlc_object_t *p_this )
         i_codec_id = CODEC_ID_MP2;
         psz_namecodec = "MPEG I/II Layer 2";
     }
+    else if( p_enc->fmt_out.i_codec == VLC_CODEC_MP1V )
+    {
+        i_cat = VIDEO_ES;
+        i_codec_id = CODEC_ID_MPEG1VIDEO;
+        psz_namecodec = "MPEG-1 video";
+    }
     else if( !GetFfmpegCodec( p_enc->fmt_out.i_codec, &i_cat, &i_codec_id,
                              &psz_namecodec ) )
     {
@@ -347,37 +353,12 @@ int OpenEncoder( vlc_object_t *p_this )
     p_sys->p_interleave_buffer = NULL;
     p_sys->i_buffer_out = 0;
 
-#if LIBAVCODEC_VERSION_MAJOR < 54
-    p_context = avcodec_alloc_context();
-#else
     p_context = avcodec_alloc_context3(p_codec);
-#endif
     p_sys->p_context = p_context;
     p_sys->p_context->codec_id = p_sys->p_codec->id;
     p_context->debug = var_InheritInteger( p_enc, "ffmpeg-debug" );
     p_context->opaque = (void *)p_this;
 
-    /* Set CPU capabilities */
-    unsigned i_cpu = vlc_CPU();
-    p_context->dsp_mask = 0;
-    if( !(i_cpu & CPU_CAPABILITY_MMX) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_MMX;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_MMXEXT) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_MMX2;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_3DNOW) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_3DNOW;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_SSE) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE;
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE2;
-    }
-
     p_sys->i_key_int = var_GetInteger( p_enc, ENC_CFG_PREFIX "keyint" );
     p_sys->i_b_frames = var_GetInteger( p_enc, ENC_CFG_PREFIX "bframes" );
     p_sys->i_vtolerance = var_GetInteger( p_enc, ENC_CFG_PREFIX "vt" ) * 1000;
@@ -497,8 +478,10 @@ int OpenEncoder( vlc_object_t *p_this )
         p_context->dark_masking = p_sys->f_dark_masking;
         p_context->p_masking = p_sys->f_p_masking;
         p_context->border_masking = p_sys->f_border_masking;
+#if (LIBAVCODEC_VERSION_MAJOR < 55)
         p_context->luma_elim_threshold = p_sys->i_luma_elim;
         p_context->chroma_elim_threshold = p_sys->i_chroma_elim;
+#endif
 
         if( p_sys->i_key_int > 0 )
             p_context->gop_size = p_sys->i_key_int;
@@ -507,13 +490,9 @@ int OpenEncoder( vlc_object_t *p_this )
         p_context->b_frame_strategy = 0;
         if( !p_context->max_b_frames  &&
             (  p_enc->fmt_out.i_codec == VLC_CODEC_MPGV ||
-               p_enc->fmt_out.i_codec == VLC_CODEC_MP2V ||
-               p_enc->fmt_out.i_codec == VLC_CODEC_MP1V ) )
+               p_enc->fmt_out.i_codec == VLC_CODEC_MP2V ) )
             p_context->flags |= CODEC_FLAG_LOW_DELAY;
 
-        if( p_enc->fmt_out.i_codec == VLC_CODEC_MP2V )
-            p_context->idct_algo = FF_IDCT_LIBMPEG2MMX;
-
         av_reduce( &p_context->sample_aspect_ratio.num,
                    &p_context->sample_aspect_ratio.den,
                    p_enc->fmt_in.video.i_sar_num,
@@ -674,7 +653,6 @@ int OpenEncoder( vlc_object_t *p_this )
     /* Misc parameters */
     p_context->bit_rate = p_enc->fmt_out.i_bitrate;
 
-#if LIBAVCODEC_VERSION_INT >= AV_VERSION_INT( 52, 69, 2 )
     /* Set reasonable defaults to VP8, based on
        libvpx-720p preset from libvpx ffmpeg-patch */
     if( i_codec_id == CODEC_ID_VP8 )
@@ -722,7 +700,6 @@ int OpenEncoder( vlc_object_t *p_this )
         p_context->mb_static_threshold = 0;
 #endif
     }
-#endif
 
     if( i_codec_id == CODEC_ID_RAWVIDEO )
     {
@@ -743,11 +720,7 @@ int OpenEncoder( vlc_object_t *p_this )
 
     int ret;
     vlc_avcodec_lock();
-#if LIBAVCODEC_VERSION_MAJOR < 54
-    ret = avcodec_open( p_context, p_codec );
-#else
     ret = avcodec_open2( p_context, p_codec, NULL /* options */ );
-#endif
     vlc_avcodec_unlock();
     if( ret )
     {
@@ -801,11 +774,7 @@ int OpenEncoder( vlc_object_t *p_this )
 
             p_context->codec = NULL;
             vlc_avcodec_lock();
-#if LIBAVCODEC_VERSION_MAJOR < 54
-            ret = avcodec_open( p_context, p_codec );
-#else
             ret = avcodec_open2( p_context, p_codec, NULL /* options */ );
-#endif
             vlc_avcodec_unlock();
             if( ret )
             {
@@ -885,7 +854,7 @@ int OpenEncoder( vlc_object_t *p_this )
         p_enc->fmt_out.audio.i_bitspersample = aout_BitsPerSample( vlc_fourcc_GetCodec( AUDIO_ES, p_enc->fmt_out.i_codec ) );
 
         if( p_context->frame_size > 1 )
-            p_sys->i_buffer_out = 8 * AVCODEC_MAX_AUDIO_FRAME_SIZE;
+            p_sys->i_buffer_out = 8 * MAX_AUDIO_FRAME_SIZE;
         else
             p_sys->i_buffer_out = p_sys->i_frame_size * p_sys->i_sample_bytes;
         p_sys->p_buffer_out = malloc( p_sys->i_buffer_out );
